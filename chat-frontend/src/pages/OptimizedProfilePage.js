import React, { useState, useEffect } from 'react';\nimport { useAuth } from '../context/AuthContext';\nimport { useParams } from 'react-router-dom';\nimport MainLayout from '../layouts/MainLayout';\nimport { usersAPI } from '../api';\nimport useResponsive from '../hooks/useResponsive';\nimport useSettings from '../hooks/useSettings';\nimport ProfilePictureDialog from '../components/ProfilePictureDialog';\nimport {\n  MobileCard,\n  MobileSwitch,\n  MobileFormControlLabel,\n  MobileSelect,\n  MobileButton,\n  MobileSettingsSection,\n  MobileColorPicker,\n} from '../components/MobileOptimizedComponents';\nimport {\n  Container,\n  Typography,\n  Avatar,\n  TextField,\n  Grid,\n  Box,\n  List,\n  ListItem,\n  ListItemText,\n  ListItemSecondaryAction,\n  IconButton,\n  Chip,\n  Tabs,\n  Tab,\n  Accordion,\n  AccordionSummary,\n  AccordionDetails,\n  Alert,\n  Snackbar,\n  CircularProgress,\n  LinearProgress,\n  FormControl,\n  InputLabel,\n  MenuItem,\n} from '@mui/material';\nimport {\n  Check,\n  Close,\n  PhotoCamera,\n  Save,\n  Notifications,\n  Security,\n  Palette,\n  Storage,\n  Settings,\n  ExpandMore,\n  Delete,\n  Backup,\n  Download,\n} from '@mui/icons-material';\nimport { useTheme } from '../context/ThemeContext';\n\nconst OptimizedProfilePage = () => {\n  const { user, updateUserProfile } = useAuth();\n  const { username } = useParams();\n  const isOwnProfile = !username || username === user?.username;\n  const { isMobile } = useResponsive();\n  const { darkMode, primaryColor, accentColor, fontSize, toggleDarkMode, updatePrimaryColor, updateAccentColor, updateFontSize } = useTheme() || {};\n  \n  const [status, setStatus] = useState(user?.status || '');\n  const [bio, setBio] = useState(user?.bio || '');\n  const [loading, setLoading] = useState(false);\n  const [tabValue, setTabValue] = useState(0);\n  const [profileData, setProfileData] = useState(null);\n  const [snackbar, setSnackbar] = useState({ open: false, message: '', severity: 'success' });\n  const [friendRequests, setFriendRequests] = useState({ sent_requests: [], received_requests: [] });\n  const [storageInfo, setStorageInfo] = useState({ used: 245, total: 1000, messages: 120, media: 95, cache: 30 });\n\n  // Settings management with debounced saving\n  const {\n    settings,\n    updateNestedSetting,\n    saveSettings,\n    loading: settingsLoading,\n    error: settingsError\n  } = useSettings({\n    notifications: {\n      new_messages: true,\n      friend_requests: true,\n      mentions: true,\n      sound_enabled: true,\n      push_notifications: true,\n    },\n    privacy: {\n      profile_visibility: 'public',\n      last_seen: 'everyone',\n      read_receipts: true,\n      online_status: true,\n    },\n    chat: {\n      auto_download_media: 'wifi',\n      enter_to_send: true,\n      show_timestamps: true,\n    }\n  });\n\n  // Profile Picture State\n  const [profilePicture, setProfilePicture] = useState(user?.profile_picture || null);\n  const [profilePicturePrivacy, setProfilePicturePrivacy] = useState(user?.profile_privacy || 'public');\n  const [profilePictureDialog, setProfilePictureDialog] = useState(false);\n\n  const showSnackbar = (message, severity = 'success') => {\n    setSnackbar({ open: true, message, severity });\n  };\n\n  const handleProfilePictureUpdate = (newPicture) => {\n    setProfilePicture(newPicture);\n    showSnackbar('Profile picture updated successfully!');\n  };\n\n  const handleProfilePicturePrivacyChange = (newPrivacy) => {\n    setProfilePicturePrivacy(newPrivacy);\n    showSnackbar('Privacy settings updated!');\n  };\n\n  const handleSave = async () => {\n    try {\n      setLoading(true);\n      await usersAPI.updateProfile({ status, bio });\n      updateUserProfile({ status, bio });\n      showSnackbar('Profile updated successfully!');\n    } catch (error) {\n      console.error('Failed to update profile:', error);\n      showSnackbar('Failed to update profile', 'error');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleClearCache = async () => {\n    try {\n      await usersAPI.clearCache();\n      setStorageInfo(prev => ({ ...prev, cache: 0 }));\n      showSnackbar('Cache cleared successfully!');\n    } catch (error) {\n      showSnackbar('Failed to clear cache', 'error');\n    }\n  };\n\n  const handleBackupData = async () => {\n    try {\n      const response = await usersAPI.backupUserData();\n      const blob = new Blob([JSON.stringify(response.data)], { type: 'application/json' });\n      const url = URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = `nexus-chat-backup-${new Date().toISOString().split('T')[0]}.json`;\n      a.click();\n      showSnackbar('Data backup downloaded!');\n    } catch (error) {\n      showSnackbar('Backup feature coming soon!', 'info');\n    }\n  };\n\n  const handleExportData = async () => {\n    try {\n      const response = await usersAPI.exportUserData();\n      const blob = new Blob([response.data], { type: 'text/csv' });\n      const url = URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = `nexus-chat-export-${new Date().toISOString().split('T')[0]}.csv`;\n      a.click();\n      showSnackbar('Data exported successfully!');\n    } catch (error) {\n      showSnackbar('Export feature coming soon!', 'info');\n    }\n  };\n\n  useEffect(() => {\n    if (isOwnProfile) {\n      fetchFriendRequests();\n      loadStorageInfo();\n    } else {\n      fetchUserProfile(username);\n    }\n  }, [username, isOwnProfile]);\n\n  const fetchUserProfile = async (targetUsername) => {\n    try {\n      setLoading(true);\n      const response = await usersAPI.getUserProfile(targetUsername);\n      setProfileData(response.data);\n    } catch (error) {\n      console.error('Failed to fetch user profile:', error);\n      setProfileData({ error: 'Profile not found or unavailable' });\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const fetchFriendRequests = async () => {\n    try {\n      const response = await usersAPI.getFriendRequests();\n      setFriendRequests(response.data);\n    } catch (error) {\n      console.error('Failed to fetch friend requests:', error);\n    }\n  };\n\n  const loadStorageInfo = async () => {\n    try {\n      const response = await usersAPI.getStorageInfo();\n      setStorageInfo(response.data);\n    } catch (error) {\n      // Use fallback data if API fails\n      console.log('Using fallback storage data');\n    }\n  };\n\n  const handleAcceptFriendRequest = async (sender) => {\n    try {\n      await usersAPI.acceptFriendRequest(sender);\n      fetchFriendRequests();\n      showSnackbar(`Accepted friend request from ${sender}`);\n    } catch (error) {\n      showSnackbar('Failed to accept friend request', 'error');\n    }\n  };\n\n  const handleRejectFriendRequest = async (sender) => {\n    try {\n      await usersAPI.rejectFriendRequest(sender);\n      fetchFriendRequests();\n      showSnackbar(`Rejected friend request from ${sender}`);\n    } catch (error) {\n      showSnackbar('Failed to reject friend request', 'error');\n    }\n  };\n\n  // Component Sections\n  const ProfileSection = () => (\n    <MobileSettingsSection\n      title=\"Profile Information\"\n      description=\"Manage your profile details and picture\"\n    >\n      <Grid container spacing={3}>\n        <Grid item xs={12} sm={4} sx={{ textAlign: 'center' }}>\n          <Avatar\n            src={profilePicture}\n            sx={{ \n              width: isMobile ? 100 : 120, \n              height: isMobile ? 100 : 120, \n              mx: 'auto', \n              mb: 2,\n              border: '4px solid',\n              borderColor: 'primary.main'\n            }}\n          >\n            {user?.username?.charAt(0).toUpperCase()}\n          </Avatar>\n          <MobileButton\n            variant=\"outlined\"\n            startIcon={<PhotoCamera />}\n            onClick={() => setProfilePictureDialog(true)}\n            fullWidth={isMobile}\n          >\n            Change Photo\n          </MobileButton>\n        </Grid>\n        <Grid item xs={12} sm={8}>\n          <TextField\n            fullWidth\n            label=\"Username\"\n            value={user?.username || ''}\n            disabled\n            margin=\"normal\"\n            sx={{ mb: 2 }}\n          />\n          <TextField\n            fullWidth\n            label=\"Status\"\n            value={status}\n            onChange={(e) => setStatus(e.target.value)}\n            margin=\"normal\"\n            multiline\n            rows={2}\n            placeholder=\"What's on your mind?\"\n            sx={{ mb: 2 }}\n          />\n          <TextField\n            fullWidth\n            label=\"Bio\"\n            value={bio}\n            onChange={(e) => setBio(e.target.value)}\n            margin=\"normal\"\n            multiline\n            rows={3}\n            placeholder=\"Tell others about yourself...\"\n            sx={{ mb: 2 }}\n          />\n          <MobileButton\n            variant=\"contained\"\n            onClick={handleSave}\n            startIcon={<Save />}\n            disabled={loading}\n            fullWidth={isMobile}\n          >\n            {loading ? 'Saving...' : 'Save Changes'}\n          </MobileButton>\n        </Grid>\n      </Grid>\n    </MobileSettingsSection>\n  );\n\n  const NotificationsSection = () => (\n    <MobileSettingsSection\n      title=\"Notifications\"\n      icon={<Notifications />}\n      description=\"Control how you receive notifications\"\n    >\n      <Grid container spacing={2}>\n        {Object.entries(settings.notifications || {}).map(([key, value]) => (\n          <Grid item xs={12} sm={6} key={key}>\n            <MobileFormControlLabel\n              control={\n                <MobileSwitch\n                  checked={value}\n                  onChange={(e) => updateNestedSetting('notifications', key, e.target.checked)}\n                />\n              }\n              label={key.replace(/_/g, ' ').replace(/\\b\\w/g, l => l.toUpperCase())}\n            />\n          </Grid>\n        ))}\n      </Grid>\n      {settingsError && (\n        <Alert severity=\"error\" sx={{ mt: 2 }}>\n          {settingsError}\n        </Alert>\n      )}\n    </MobileSettingsSection>\n  );\n\n  const PrivacySection = () => (\n    <MobileSettingsSection\n      title=\"Privacy & Security\"\n      icon={<Security />}\n      description=\"Manage your privacy settings\"\n    >\n      <Grid container spacing={3}>\n        <Grid item xs={12} sm={6}>\n          <FormControl fullWidth margin=\"normal\">\n            <InputLabel>Profile Visibility</InputLabel>\n            <MobileSelect\n              value={settings.privacy?.profile_visibility || 'public'}\n              onChange={(e) => updateNestedSetting('privacy', 'profile_visibility', e.target.value)}\n            >\n              <MenuItem value=\"public\">Public</MenuItem>\n              <MenuItem value=\"friends\">Friends Only</MenuItem>\n              <MenuItem value=\"private\">Private</MenuItem>\n            </MobileSelect>\n          </FormControl>\n        </Grid>\n        <Grid item xs={12} sm={6}>\n          <FormControl fullWidth margin=\"normal\">\n            <InputLabel>Last Seen</InputLabel>\n            <MobileSelect\n              value={settings.privacy?.last_seen || 'everyone'}\n              onChange={(e) => updateNestedSetting('privacy', 'last_seen', e.target.value)}\n            >\n              <MenuItem value=\"everyone\">Everyone</MenuItem>\n              <MenuItem value=\"friends\">Friends Only</MenuItem>\n              <MenuItem value=\"nobody\">Nobody</MenuItem>\n            </MobileSelect>\n          </FormControl>\n        </Grid>\n        {Object.entries(settings.privacy || {})\n          .filter(([key]) => !['profile_visibility', 'last_seen'].includes(key))\n          .map(([key, value]) => (\n            <Grid item xs={12} sm={6} key={key}>\n              <MobileFormControlLabel\n                control={\n                  <MobileSwitch\n                    checked={value}\n                    onChange={(e) => updateNestedSetting('privacy', key, e.target.checked)}\n                  />\n                }\n                label={key.replace(/_/g, ' ').replace(/\\b\\w/g, l => l.toUpperCase())}\n              />\n            </Grid>\n          ))\n        }\n      </Grid>\n    </MobileSettingsSection>\n  );\n\n  const AppearanceSection = () => (\n    <MobileSettingsSection\n      title=\"Appearance\"\n      icon={<Palette />}\n      description=\"Customize your chat experience\"\n    >\n      <Grid container spacing={3}>\n        <Grid item xs={12}>\n          <MobileFormControlLabel\n            control={<MobileSwitch checked={darkMode || false} onChange={toggleDarkMode || (() => {})} />}\n            label=\"Dark Mode\"\n          />\n        </Grid>\n        <Grid item xs={12} sm={6}>\n          <FormControl fullWidth margin=\"normal\">\n            <InputLabel>Font Size</InputLabel>\n            <MobileSelect\n              value={fontSize || 'medium'}\n              onChange={(e) => updateFontSize && updateFontSize(e.target.value)}\n            >\n              <MenuItem value=\"small\">Small</MenuItem>\n              <MenuItem value=\"medium\">Medium</MenuItem>\n              <MenuItem value=\"large\">Large</MenuItem>\n              <MenuItem value=\"xlarge\">Extra Large</MenuItem>\n            </MobileSelect>\n          </FormControl>\n        </Grid>\n        <Grid item xs={12} sm={6}>\n          <MobileColorPicker\n            label=\"Primary Color\"\n            value={primaryColor || '#667eea'}\n            onChange={(color) => updatePrimaryColor && updatePrimaryColor(color)}\n            fullWidth={isMobile}\n          />\n        </Grid>\n        <Grid item xs={12} sm={6}>\n          <MobileColorPicker\n            label=\"Accent Color\"\n            value={accentColor || '#764ba2'}\n            onChange={(color) => updateAccentColor && updateAccentColor(color)}\n            fullWidth={isMobile}\n          />\n        </Grid>\n      </Grid>\n    </MobileSettingsSection>\n  );\n\n  const StorageSection = () => (\n    <MobileSettingsSection\n      title=\"Storage & Data\"\n      icon={<Storage />}\n      description=\"Manage your data usage and storage\"\n    >\n      <Box sx={{ mb: 3 }}>\n        <Typography variant=\"body2\" color=\"text.secondary\" gutterBottom>\n          Storage Used: {storageInfo.used}MB / {storageInfo.total}MB\n        </Typography>\n        <LinearProgress\n          variant=\"determinate\"\n          value={(storageInfo.used / storageInfo.total) * 100}\n          sx={{ height: isMobile ? 12 : 8, borderRadius: 4 }}\n        />\n      </Box>\n      <Grid container spacing={2}>\n        <Grid item xs={4}>\n          <Box sx={{ textAlign: 'center', p: 2, bgcolor: 'background.paper', borderRadius: 2 }}>\n            <Typography variant=\"h6\">{storageInfo.messages}MB</Typography>\n            <Typography variant=\"caption\" color=\"text.secondary\">Messages</Typography>\n          </Box>\n        </Grid>\n        <Grid item xs={4}>\n          <Box sx={{ textAlign: 'center', p: 2, bgcolor: 'background.paper', borderRadius: 2 }}>\n            <Typography variant=\"h6\">{storageInfo.media}MB</Typography>\n            <Typography variant=\"caption\" color=\"text.secondary\">Media</Typography>\n          </Box>\n        </Grid>\n        <Grid item xs={4}>\n          <Box sx={{ textAlign: 'center', p: 2, bgcolor: 'background.paper', borderRadius: 2 }}>\n            <Typography variant=\"h6\">{storageInfo.cache}MB</Typography>\n            <Typography variant=\"caption\" color=\"text.secondary\">Cache</Typography>\n          </Box>\n        </Grid>\n      </Grid>\n      <Box sx={{ mt: 3, display: 'flex', gap: 2, flexDirection: isMobile ? 'column' : 'row' }}>\n        <MobileButton\n          variant=\"outlined\"\n          startIcon={<Delete />}\n          onClick={handleClearCache}\n          fullWidth={isMobile}\n        >\n          Clear Cache\n        </MobileButton>\n        <MobileButton\n          variant=\"outlined\"\n          startIcon={<Backup />}\n          onClick={handleBackupData}\n          fullWidth={isMobile}\n        >\n          Backup Data\n        </MobileButton>\n        <MobileButton\n          variant=\"outlined\"\n          startIcon={<Download />}\n          onClick={handleExportData}\n          fullWidth={isMobile}\n        >\n          Export Data\n        </MobileButton>\n      </Box>\n    </MobileSettingsSection>\n  );\n\n  const FriendsSection = () => (\n    <MobileSettingsSection\n      title=\"Friend Requests\"\n      description={`${friendRequests.received_requests?.length || 0} received, ${friendRequests.sent_requests?.length || 0} sent`}\n    >\n      <Tabs value={tabValue} onChange={(e, newValue) => setTabValue(newValue)} sx={{ mb: 2 }}>\n        <Tab label={`Received (${friendRequests.received_requests?.length || 0})`} />\n        <Tab label={`Sent (${friendRequests.sent_requests?.length || 0})`} />\n      </Tabs>\n      {tabValue === 0 && (\n        <List>\n          {friendRequests.received_requests?.length === 0 ? (\n            <Typography color=\"text.secondary\">No received friend requests</Typography>\n          ) : (\n            friendRequests.received_requests?.map((sender) => (\n              <ListItem key={sender} sx={{ px: 0 }}>\n                <ListItemText primary={sender} />\n                <ListItemSecondaryAction>\n                  <IconButton \n                    color=\"success\" \n                    onClick={() => handleAcceptFriendRequest(sender)}\n                    sx={{ mr: 1 }}\n                  >\n                    <Check />\n                  </IconButton>\n                  <IconButton \n                    color=\"error\" \n                    onClick={() => handleRejectFriendRequest(sender)}\n                  >\n                    <Close />\n                  </IconButton>\n                </ListItemSecondaryAction>\n              </ListItem>\n            ))\n          )}\n        </List>\n      )}\n      {tabValue === 1 && (\n        <List>\n          {friendRequests.sent_requests?.length === 0 ? (\n            <Typography color=\"text.secondary\">No sent friend requests</Typography>\n          ) : (\n            friendRequests.sent_requests?.map((receiver) => (\n              <ListItem key={receiver} sx={{ px: 0 }}>\n                <ListItemText primary={receiver} />\n                <Chip label=\"Pending\" color=\"warning\" size=\"small\" />\n              </ListItem>\n            ))\n          )}\n        </List>\n      )}\n    </MobileSettingsSection>\n  );\n\n  const settingsSections = [\n    { id: 'profile', title: 'Profile', component: ProfileSection },\n    { id: 'notifications', title: 'Notifications', component: NotificationsSection },\n    { id: 'privacy', title: 'Privacy', component: PrivacySection },\n    { id: 'appearance', title: 'Appearance', component: AppearanceSection },\n    { id: 'storage', title: 'Storage', component: StorageSection },\n    { id: 'friends', title: 'Friends', component: FriendsSection },\n  ];\n\n  if (loading && !isOwnProfile) {\n    return (\n      <MainLayout>\n        <Container maxWidth=\"md\" sx={{ py: 4, textAlign: 'center' }}>\n          <CircularProgress />\n        </Container>\n      </MainLayout>\n    );\n  }\n\n  return (\n    <MainLayout>\n      <Container maxWidth={isMobile ? 'sm' : 'lg'} sx={{ py: isMobile ? 2 : 4 }}>\n        <Typography variant={isMobile ? 'h5' : 'h4'} gutterBottom sx={{ mb: 3 }}>\n          {isOwnProfile ? 'Settings & Profile' : `${username}'s Profile`}\n        </Typography>\n        \n        {isOwnProfile ? (\n          <Box>\n            {isMobile ? (\n              // Mobile: Accordion Layout\n              <Box>\n                {settingsSections.map((section) => (\n                  <Accordion key={section.id} sx={{ mb: 1, borderRadius: '12px !important' }}>\n                    <AccordionSummary expandIcon={<ExpandMore />}>\n                      <Typography variant=\"h6\">{section.title}</Typography>\n                    </AccordionSummary>\n                    <AccordionDetails>\n                      <section.component />\n                    </AccordionDetails>\n                  </Accordion>\n                ))}\n              </Box>\n            ) : (\n              // Desktop: Tab Layout\n              <Box>\n                <Tabs\n                  value={tabValue}\n                  onChange={(e, newValue) => setTabValue(newValue)}\n                  variant=\"scrollable\"\n                  scrollButtons=\"auto\"\n                  sx={{ borderBottom: 1, borderColor: 'divider', mb: 3 }}\n                >\n                  {settingsSections.map((section) => (\n                    <Tab key={section.id} label={section.title} />\n                  ))}\n                </Tabs>\n                {settingsSections.map((section, index) => (\n                  <Box\n                    key={section.id}\n                    role=\"tabpanel\"\n                    hidden={tabValue !== index}\n                  >\n                    {tabValue === index && <section.component />}\n                  </Box>\n                ))}\n              </Box>\n            )}\n          </Box>\n        ) : (\n          // Public Profile View\n          <MobileCard>\n            <Box sx={{ p: 3 }}>\n              <Grid container spacing={3}>\n                <Grid item xs={12} sm={4} sx={{ textAlign: 'center' }}>\n                  <Avatar\n                    src={profileData?.profile_picture}\n                    sx={{ width: 120, height: 120, mx: 'auto', mb: 2 }}\n                  >\n                    {username?.charAt(0).toUpperCase()}\n                  </Avatar>\n                  <Typography variant=\"h6\">{username}</Typography>\n                  <Chip\n                    label={profileData?.status || 'Offline'}\n                    color={profileData?.status === 'online' ? 'success' : 'default'}\n                    size=\"small\"\n                    sx={{ mt: 1 }}\n                  />\n                </Grid>\n                <Grid item xs={12} sm={8}>\n                  <Typography variant=\"h6\" gutterBottom>About</Typography>\n                  <Typography variant=\"body1\" sx={{ mb: 2 }}>\n                    {profileData?.status || 'No status set'}\n                  </Typography>\n                  <Typography variant=\"h6\" gutterBottom>Bio</Typography>\n                  <Typography variant=\"body1\">\n                    {profileData?.bio || 'No bio available'}\n                  </Typography>\n                </Grid>\n              </Grid>\n            </Box>\n          </MobileCard>\n        )}\n\n        {/* Snackbar for notifications */}\n        <Snackbar\n          open={snackbar.open}\n          autoHideDuration={4000}\n          onClose={() => setSnackbar({ ...snackbar, open: false })}\n        >\n          <Alert\n            severity={snackbar.severity}\n            onClose={() => setSnackbar({ ...snackbar, open: false })}\n          >\n            {snackbar.message}\n          </Alert>\n        </Snackbar>\n\n        {/* Profile Picture Dialog */}\n        <ProfilePictureDialog\n          open={profilePictureDialog}\n          onClose={() => setProfilePictureDialog(false)}\n          currentPicture={profilePicture}\n          onUpdate={handleProfilePictureUpdate}\n          privacy={profilePicturePrivacy}\n          onPrivacyChange={handleProfilePicturePrivacyChange}\n        />\n      </Container>\n    </MainLayout>\n  );\n};\n\nexport default OptimizedProfilePage;